{% extends "base.html" %}

<!-- templates/user/creation_view.html -->

{% block title%}
Creation View
{% endblock %}

{% block wrapper%}<div align="centre"><h1 class="display-4">Creation {{creation.name}} </h1></div>{% endblock %}

{% block content %}
<div id="creation_details_view" class='container creation'>
    <div class="creation_details align-right">
            <p>
                <strong>Regex Filter</strong>:{{creation.regexfilter}}
            </p>
            <p>
                <strong>Creator Name</strong>:
                <a href="{{ url_for('app_views.rud_creator', creator_id=creation.creator_id)}}">{{creation.creator.name}}
                </a>
            </p>
    </div>
    <div class="creation_details_delete float-right">
        <form class="" action="{{ url_for('app_views.rud_creation', creator_id=creation.creator_id, creation_id=creation.id)}}" method="POST">
        					<input name="_method" value="DELETE" hidden>
        					<input class="btn btn-primary btn-sm btn-danger" id="submit" label="delete" name="" type="submit" value="Delete {{ creation.name.split(' ')[0].capitalize() }}">
        </form>
        	</br>
    </div>
    <div class="creation_details_edit_button float-right">
        <button id="edit_creation_btn" type="button" class="btn btn-primary btn-sm  btn-link"> Edit {{ creation.name.split(' ')[0].capitalize() }} </button>
    </div>
    <div class="creation_details_clean float-right">
        <form class="" action="{{ url_for('app_views.rud_creation', creator_id=creation.creator_id, creation_id=creation.id)}}" method="POST">
        					<input name="_method" value="CLEAN" hidden>
        					<input class="btn btn-primary btn-sm btn-warning" id="submit" label="Clean" name="" type="submit" value="Clean {{ creation.name.split(' ')[0].capitalize() }}">
        </form>
        	</br>
    </div>
</div>
<div id="creation_details_edit" class='container creation'>
    <form action="{{ url_for('app_views.rud_creation', creator_id=creation.creator_id, creation_id=creation.id)}}" method="POST">
    	<table>
    		<tbody>
                {{ form.csrf_token }}
                {% for field in form if not field.name in ["csrf_token", 'submit'] %}
            		<tr>
                		<td>{{ field.label }}</td>
                		<td>{{ field }}</td>
                		</td><b>{{ " ".join(field.errors) }}</b></td>
            		</tr>
            	{% endfor %}
                <tr>
                    <td>{{form.submit}}</td>
                </tr>
        		<tr>
        		    <td><button id="cancel_change_btn"class="btn btn-primary btn-sm btn-warning"> Cancel </button></td>
        	    </tr>
    		</tbody>
    	</table>
    </form>
</div>
<div id="posts_in_creation">
	<h4 class="h4"> <a href=""> Posts </a> </h4> </br>
	<div class="well card card-body bg-light">
	{% if posts %}
	<ul>
		{% for post in posts %}
		<li>
			<a href="{{ url_for('app_views.rud_post', creator_id=creation.creator_id, creation_id=creation.id, post_id=post.id)}}"> {{post.title}} </a> - {{post.fetched_at}}
		</li>
		{% endfor %}
	</ul>
	{% endif %}
	</br>
	<a href="{{ url_for('app_views.create_post', creator_id=creation.creator_id, creation_id=creation.id )}}"> Add Post </a>
	</div>
</div>
<!-- Unread Posts EPUB Export Section -->
{% if current_user.is_authenticated and unread_posts %}
<div id="unread_epub_section" class="mt-4">
  <h5>Select Unread Posts to Export as EPUB</h5>
  <form id="epub_export_form" method="post" action="{{ url_for('app_views.export_epub') }}">
    <div class="mb-2">
      <button type="button" class="btn btn-sm btn-secondary" onclick="selectAllUnread(true)">Select All</button>
      <button type="button" class="btn btn-sm btn-secondary" onclick="selectAllUnread(false)">Deselect All</button>
    </div>
    <ul id="unread_posts_list" class="list-group mb-2">
      {% for post in unread_posts %}
      <li class="list-group-item d-flex align-items-center" draggable="true">
        <input type="checkbox" name="post_ids" value="{{ post.id }}" class="mr-2" checked>
        <span class="post-title">{{ post.title }}</span>
        <span class="ml-auto text-muted small">{{ post.fetched_at }}</span>
      </li>
      {% endfor %}
    </ul>
    <div class="form-check mb-2">
      <input class="form-check-input" type="checkbox" name="mark_as_read" id="mark_as_read">
      <label class="form-check-label" for="mark_as_read">Mark selected posts as read after export</label>
    </div>
    <button type="submit" class="btn btn-primary">Generate EPUB</button>
  </form>
  <small class="text-muted">Drag to reorder posts before exporting.</small>
</div>
<script>
function selectAllUnread(val) {
  document.querySelectorAll('#unread_posts_list input[type="checkbox"]').forEach(cb => cb.checked = val);
}
// Simple drag-and-drop reordering
const list = document.getElementById('unread_posts_list');
let dragSrcEl = null;
list.addEventListener('dragstart', function(e) {
  dragSrcEl = e.target;
  e.dataTransfer.effectAllowed = 'move';
});
list.addEventListener('dragover', function(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
});
list.addEventListener('drop', function(e) {
  e.preventDefault();
  if (e.target.tagName === 'LI' && dragSrcEl !== e.target) {
    list.insertBefore(dragSrcEl, e.target.nextSibling);
  }
});
</script>
{% endif %}
	</br>




<script>
document.getElementById("edit_creation_btn").addEventListener("click", showEdit);
document.getElementById("cancel_change_btn").addEventListener("click", hideEdit);
document.getElementById("creation_details_edit").style.display = "none";
function showEdit() {
	document.getElementById("creation_details_view").style.display = "none";
	document.getElementById("creation_details_edit").style.display = "block";
}
function hideEdit() {
	document.getElementById("creation_details_edit").style.display = "none";
	document.getElementById("creation_details_view").style.display = "block";
}
</script>

{% endblock %}